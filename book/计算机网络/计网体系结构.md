---
title: 计网体系结构
date: 2019-08-10
---

## 1. 通信原理

一个数据通信系统可划分为三大部分，即**源系统（发送端）**、**传输系统（传输网络）**、**目的系统（接收端）**。

通信的目的是传送消息，**数据**(data)是运送消息的实体，**信号**(signal)则是数据的电气或电磁的表现。

### 1.1 信号与信道

信号根据其代表消息的取值方式不同，可分为两类：

![](https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/26.png)

- **模拟信号**（或连续信号）——代表消息的参数的取值是连续的。
- **数字信号**（或离散信号）——代表消息的参数的取值是离散的。在使用时间域（时域）的波形表示数字信号时，代表不同离散数值的基本波形就称为**码元**。在使用二进制编码时，只有两种不同的码元，一种代表0状态而另一种代表1状态。

**信道(channel)** 一般用来表示向某一个方向传送信息的媒体。信道和电路并不等同，一条通信电路往往包含一条发送信道和一条接收信道。

### 1.2 通信的方式

通信有三种基本方式：

> 单向通信只需要一条信道，而双向交替通信或双向同时通信则都需要两条信道（每个方向各一条）。显然，双向同时通信的传输效率最高。

1. **单向通信（单工通信）**——即只能有一个方向的通信而没有反方向的交互。如无线电广播、有线电广播、电视广播

2. **双向交替通信（半双工通信）**——通信的双方都可以发送信息，但不能双方同时发送（当然也就不能同时接收）。

3. **双向同时通信（全双工通信）**——通信的双方可以同时发送和接收信息。

### 1.3 调制

来自信源的信号常称为**基带信号**（即基本频带信号）。基带信号往往包含有较多的低频成分，甚至有直流成分，而许多信道并不能传输这种低频分量或直流分量，为此，就必须对基带信号进行**调制**(modulation)。

- **基带调制（编码）**——仅仅对基带信号的波形进行变换，使它能够与信道特性相适应，变换后的信号仍然是基带信号。由于这种调制是把数字信号转换为另一种形式的基带信号，因此大家更愿意把这种过程称为编码(coding)。

    ![](https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/27.png)

- **带通调制（载波）**——使用载波(carrier)进行调制，把基带信号的频率范围搬移到较高的频段，并转换为模拟信号，这样就能够更好地在模拟信道中传输。经过载波调制后的信号称为带通信号，即仅在一段频率范围内能够通过信道。

    ![](https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/28.png)

### 1.4 数字通信的优点

数字通信的优点就是：虽然信号在信道上传输时会不可避免地产生失真，但在接收端只要我们从失真的波形中能够识别出原来的信号，那么这种失真对通信质量就没有影响。码元传输的速率越高，或信号传输的距离越远，或噪声干扰越大，或传输媒体质量越差，在接收端的波形的失真就越严重。

![](https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/29.png)

### 1.5 其他概念

**信噪比**——信号的平均功率和噪声的平均功率之比，常记为S/N，并用分贝(dB)作为度量单位。即：
$$
信噪比（dB）=10log_{10}(\frac{S}{N})\;(dB)
$$
**香农公式**——信道的极限信息传输速率C是$C=Wlog_2(1+\frac{S}{N})\;(bit/s)$。香农公式表明，信道的带宽或信道中的信噪比越大，信息的极限传输速率就越高。香农公式指出了信息传输速率的上限。

**复用(multiplexing)** 是通信技术中的基本概念，如下图。信道复用技术主要有：

![](https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/30.png)

- 频分复用FDM(Frequency Division Multiplexing
- 时分复用TDM(Time Division Multiplexing)
- 统计时分复用STDM(Statstic TDM)
- 波分复用WDM(Wavelength Division Multiplexing)
- 码分复用CDM(Code Division Multiplexing)——即码分多址CDMA(Code Division Multiple Access)，码分复用最初用于军事通信，因为这种系统发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现。

## 2. 物理层

> **物理层协议**也常叫做物理层规程，因为在“协议”这个名词出现之前人们就先使用了“规程”这一名词。

可以将物理层的主要**任务**描述为确定与传输媒体的接口有关的一些特性。

物理层下面的**传输媒体**（即传输介质）它不属于物理层，是数据传输系统中在发送器和接收器之间的物理通路，可分为：

- **导引型传输媒体**：电磁波被导引沿着固体媒体（铜钱或光纤）传播。
- **非导引型传输媒体**：即自由空间，在非导引型传输媒体中电磁波的传输常称为无线传输。

在互联网的发展初期，用户都是利用电话的用户线通过调制解调器连接ISP的，经过多年的努力，从电话的用户线接入到互联网的速率最高只能达到56 kbit/s。为了提高用户的上网速率，近年来已经有多种宽带技术进入用户的家庭，然而目前“**宽带**”尚无统一的定义。

用户到互联网的宽带接入方法有：

- ADSL：用数字技术对现有的模拟电话用户线进行改造
- HFC：在有线电视网的基础上开发的
- FTTx：光纤到x

## 3. 数据链路层

> 数据链路层不必考虑物理层如何实现比特传输的细节。

链路和数据链路并不是一回事：

1. **链路**：从一个结点到相邻结点的一段物理线路（有线或无线），而中间没有任何其他的交换结点。

2. **数据链路**：当需要在一条线路上传送数据时，除了必须有一条物理线路外，还必须有一些必要的通信协议来控制这些数据的传输，把实现这些协议的硬件和软件加到链路上，即构成数据链路。最常用的方法是使用**网络适配器**（既有硬件，又有软件）来实现这些协议，一般的网络适配器都包括了数据链路层和物理层这两层的功能。

数据链路层使用的信道主要有两种类型：

1. **点对点信道**：使用一对一的点对点通信方式。如PPP协议对应点对点信道。

2. **广播信道**：使用一对多的广播通信方式。**局域网**使用的即是广播信道。

### 3.1 局域网

局域网虽然是个网络，但我们并不把局域网放在网络层中讨论。这是因为在网络层要讨论的问题是多个网络互连的的问题，是讨论分组怎样从一个网络，通过路由器，转发到另一个网络。在数据链路层我们研究的是在同一个局域网中，分组怎样从一台主机传送到另一台主机，但并不经过路由器转发。从整个互联网来看，**局域网仍属于数据链路层的范围**。

必须指出，局域网工作的层次跨越了数据链路层和物理层。由于局域网技术中有关数据链路层的内容比较丰富，因此我们就把局域网的内容放在数据链路层这一章中讨论。但这不表示局域网仅仅和数据链路层有关。

局域网最主要的特点是：网络为一个单位所拥有，且地理范围和站点数目均有限。局域网经过了四十年的发展，尤其是在快速以太网(100 Mbig/s)和吉比特以太网(1 Gbit/s)、10吉比特以太网(10 Gbit/s)相继进入市场后，以太网已经在局域网市场中占据了绝对优势，现在**以太网**几乎成为了**局域网**的同义词。

![](https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/31.png)

为了通信的简便，**以太网**采取了两种措施：

1. 采用较为灵活的**无连接**的工作方式。因此，以太网提供的服务是**尽最大努力的交付**，即**不可靠交付**。

2. 以太网发送的数据都使用**曼彻斯特编码**的信号。

现在人们也在使用以太网进行宽带接入互联网。以太网接入的一个重要特点是它可以提供双向的宽带通信，并且可以根据用户对带宽的需求灵活地进行带宽升级。现在的光纤宽带接入FTTx都要使用PPPoE的方式进行接入。

需要注意的是，在用户家中墙上是通过电话使用的RJ-11插口，用普通的电话线传送PPP帧。这已经和以太网没有关系了。所以这种上网方式不能称为以太网上网，而是利用电话线宽带接入到互联网。

### 3.2 数据链路层协议及PPP

数据链路层协议有许多种，但都有三个共同的基本问题：**封闭成帧**、**透明传输**、**差错检测**。

所谓的“数据链路层透明传送数据”表示无论什么样的比特组合的数据，都能够按照原样没有差错地通过这个数据链路层。因此，对所传送的数据来说，这些数据就“看不见”数据链路层有什么妨碍数据传输的东西，或者说，数据链路层对这些数据来说是透明的。

**点对点协议PPP(Point-to-Point Protocol)** 是目前使用得最广泛的数据链路层协议。PPP协议就是用户计算机和ISP进行通信时所使用的数据链路层协议。

这里特别要提到的是在1999年公布的在以太网上运行的PPP，即PPP over Ethernet，简称为**PPPoE**，这是PPP协议能够适应多种类型链路的一个典型例子。PPPoE是为宽带上网的主机使用的链路层协议。现在，即使是只有一个用户利用**ADSL**进行宽带上网（并不和其他人共享到ISP的宽带链路），也是使用PPPoE协议。

### 3.3 适配器

计算机与外界局域网的连接是通过通信**适配器**（即所谓的**网络适配器**）(adapter)进行的，适配器又称为网络接口卡NIC(Network Interface Card)或简称为**网卡**。由于现在计算机主板上都已经嵌入了这种适配器，不再使用单独的网卡了，因此本书使用适配器这个更准确的术语。

1. 适配器在接收和发送各种帧时不使用计算机的CPU。

2. 计算机的**硬件地址**就在适配器的ROM中，而计算机的**软件地址**——IP地址则在计算机的存储器中。

    ![](https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/32.png)

在局域网中，**硬件地址**又称为**物理地址**或MAC地址（因为这种地址用在MAC帧中）。由于IEEE 802标准为局域网规定了一种 48 位的全球地址，是指局域网上的每一台计算机中**固化在适配器ROM中**的地址，导致局域网上的某台主机的“地址”根本不能告诉我们这台主机位于什么地方。因此，严格地讲局域网的“地址”应当是每一个站的“名字”，不过，现在人们还是习惯于把这种48位的“名字”称为“地址”。MAC地址实际上就是**适配器地址**或**适配器标识符。**

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/33.png" style="zoom:67%;" />

## 4. 网络层

互联网采用的设计思路是这样的：网络层向上（对上层）**只提供简单灵活的、无连接的、尽最大努力交付的数据报服务**，网络层不提供服务质量的承诺。采用这种设计思路的好处是：网络造价大大降低，运行方式灵活，能够适应多种应用。互联网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性。

由于网际协议IP是用来使互连起来的许多计算机网络能够进行通信的，因此TCP/IP体系中的网络层常常被称为**网际层**(internet layer)或**IP层**。

### 4.1 IP协议

网际协议IP是TCP/IP体系中两个最主要的协议之一。严格来讲，这里要讲的IP其实是IP的第4个版本，就记为IPv4，但在讲述IP协议的各种原理时，往往不在IP后面加上版本号。

与IP协议配套使用的还有三个协议：

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/34.png" style="zoom:80%;" />

- 地址解析协议ARP：IP使用这个协议。ARP协议的用途是从网络层使用的IP地址解析出在数据链路层使用的硬件地址。
- 网际控制报文协议ICMP：这个协议使用IP协议
- 网际组管理协议IGMP：这个协议使用IP协议

所谓**虚拟互联网络**也就是**逻辑互连网络**，意思是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用IP协议就可以使这些性能各异的网络在网络层看起来好像是一个统一的网络。这种使用IP协议的虚拟互连网络可简称为IP网（IP网是虚拟的，但平常不必每次都强调“虚拟”二字）。如果在这种覆盖全球的IP网的上层使用TCP协议，那么就是现在的**互联网**。

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/35.png" style="zoom:80%;" />

### 4.2 IP地址的编址方法演化史

整个的互联网就是一个单一的、抽象的网络。IP地址就是给互联网上的每一台主机（或路由器）的每一个接口分配一个在全世界范围内是唯一的32位的标识符。IP地址的结构使我们可以在互联网上很方便地进行寻址。

IP地址的编址方法经过了以下三个历史阶段。

#### 分类的IP地址

两级的IP地址可记为如下。其中第一个字段的网络号标志主机（或路由器）所连接到的网络，一个网络号在整个互联网范围内必须是唯一的；第二个字段的主机号标志该主机（或路由器），一台主机号在它前面的网络号所指明的网络范围内必须是唯一的。由此，一个IP地址在整个互联网范围内是唯一的。
$$
IP地址::=\{<网络号>, <主机号>\}
$$
在路由表中，每一条路由最主要的是以下两个信息：（网络地址即是IP地址中的网络号）
$$
(目的网络地址, 下一跳地址)
$$

#### 子网的划分

1985年起在IP地址中又增加了一个“子网号字段”，使两级IP地址变成为三级IP地址
$$
IP地址::=\{<网络号>, <子网号>, <主机号>\}
$$

#### 构成超网

这是比较新的**无分类编址**方法，近年来已广泛使用。

无分类编址方法的正式名称为**无分类域间路由选择CIDR**(Classless Inter-Domain Routing，CIDR的读音为"sider")，CIDR的最主要特点有三个：

- CIDR消除了传统的A类、B类和C类地址以及划分子网的概念——CIDR把32位的IP地址划分为前后两个部分，前面部分是“**网络前缀**”（或简称为**前缀**），用来指明网络，后面部分则用来指明**主机**。因此CIDR使IP地址从三级编址（使用子网掩码）又回到了两级编址，但这是无分类的的两级编址。
  
    - 另外，CIDR使用**斜线记法**，或称为CIDR记法，即在IP地址后面加上斜线“/”，然后写上网络前缀所占的位数。
    

    $$
    IP地址::=\{<网络前缀>, <主机号>\}
    $$
    
- CIDR把网络前缀都相同的连续的IP地址组成一个“CIDR地址块”——我们只要知道CIDR地址块中的任何一个地址，就可以知道这个地址块的起始地址（即最小地址）和最大地址，以及地址块中的地址数。

    | <img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/36.png" style="zoom:67%;" /> |
    | ------------------------------------------------------------ |
    | <img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/37.png" style="zoom:67%;" /> |

- 为了更方便地进行路由选择，CIDR使用32位的**地址掩码**(address mask)——地址掩码，也称**子网掩码**，由一串1和一串0组成，而1的个数就代表网络前缀的长度，其作用就是用来标记网络地址和主机地址的划分界限。

    - 斜线记法中，斜线后面的数字就是地址掩码中1的个数。


由于一个CIDR地址块中有很多地址，所以在路由表中就利用CIDR地址块来查找目的网络，这种地址的聚合常称为**路由聚合**(route aggregation)，路由聚合也称为**构成超网**(supernetting)。

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/38.png" style="zoom:67%;" />

使用CIDR以后，路由表中的项目也要有相应改变，这时每个项目主要如下。此时在查找路由表时可能会得到不止一个匹配结果，此时应进行**最长前缀匹配**，即应当从匹配结果中选择具有最长网络前缀的路由，因为前缀越长，地址块就越小，路由就越具体。
$$
(网络前缀, 下一跳地址)
$$

### 4.3 IP地址

对主机或路由器来说，IP地址都是32位的二进制代码。为了提高可读性，我们常常在表示时每8位插入一个空格；或用其等效的十进制数字表示，并且在这些数字之间加上一个点，称之为**点分十进制记法**。

![](https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/39.png)

IP地址的一些重要特点（虽然此部分来源于二级分类IP地址介绍的章节，但似乎不妨碍最终结果）：

- 每一个IP地址都由**网络号**和**主机号**组成：IP地址管理机构在分配IP地址时只分配网络号，而剩下的主机号由得到该网络号的单位自行分配；**路由器仅需根据目的主机所连接的网络号来转发分组**，而不必考虑止的主机号，减小了路由表所占的存储空间以及查找路由表的时间。
- IP地址实际上是标志一台主机（或路由器）和一条链路的接口。由于一个路由器至少应当连接到两个网络，因此一个路由器至少应当有两个不同的IP地址。
- 按照互联网的观点，**一个网络**是指具有相同网络号 net-id 的主机的集合。因此，用转发器或网桥连接起来的若干个局域网仍为一个网络。具有不同网络号的局域网必须使用路由器进行互连。
- 在IP地址中所有分配到网络号的网络都是**平等**的。所谓平等，是指互联网同等对待每一个IP地址。

#### IP地址 vs 物理地址

**物理地址**是数据链路层和物理层使用的地址，而IP地址是网络层和以上各层使用的地址，是一种由软件实现的逻辑地址。

![](https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/40.png)

在发送数据时，数据从高层下到低层，然后才到通信链路上传输，使用IP地址的IP数据报一旦交给了数据链路层，就被封装成MAC帧了，MAC帧在传送时使用的源地址和目的地址都是**硬件地址**。当IP数据报放入数据链路层的MAC帧中以后，整个的IP数据报就成为MAC帧的数据，因而在数据链路层中看不见数据报的IP地址。

| <img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/41.png" style="zoom:67%;" /> |
| ------------------------------------------------------------ |
| <img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/42.png" style="zoom:67%;" /> |

既然在网络链路上传送的帧最终是按照硬件地址找到目的主机的，那么为什么我们还要使用抽象的IP地址，而不直接使用硬件地址进行通信？

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/43.png" style="zoom:67%;" />

### 4.4 IP数据报

IP数据报的格式（其中版本号即指IPv4还是IPv6，通信双方必须保持一致）：

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/44.png" style="zoom:67%;" />

应当强调，在IP数据报的首部中没有地方可以用来指明“下一跳路由器的IP地址“。在IP数据报的首部写上的IP地址是源IP地址和目的IP地址，而没有中间经过的路由器的IP地址。当路由器收到一个待转发的数据报，在从路由表得出下一跳路由器的IP地址**（到目前为止还没有说明怎么找到下一跳路由器的，即如何构建路由表的）**后，不是把这个地址填入IP数据报，而是交送数据链路层的网络接口软件。网络接口软件负责把下一跳路由器的IP地址转换成硬件地址（必须使用ARP），并将此硬件地址放在链路层的MAC帧的首部，然后根据这个硬件地址找到下一跳路由器。

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/45.png" style="zoom:67%;" />

### 4.5 IPv6

到2011年2月，IPv4的地址已经耗尽，ISP已经不能申请到新的IP地址块了。于是有了**IPv6**的解决方案。到目前为止，IPv6还只是草案标准阶段。

一般来讲，一个IPv6数据报的**目的地址**为以下三种类型之一：

1. **单播**(unicast)——就是传统的点对点通信

2. **多播**(multicast)——一对多点的通信，数据报发送到一组计算机中的每一个。IPv6没有采用广播的术语，而是将广播看作多播的一个特例。

3. **任播**(anycast)——IPv6增加的一种类型，任播的终点是一组计算机，但数据报只交付其中一个，通常是距离最近的一个。

IPv6所引起的主要变化如下：

- **更大的地址空间**——在IPv6中，每个地址占128位。为了使地址更简洁些，IPv6使用冒号十六进制记法，把每个16位的值用十六进制值表示，各值之间用冒号分隔。

    | <img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/46.png" style="zoom:67%;" /> |
    | ------------------------------------------------------------ |
    | <img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/47.png" style="zoom:67%;" /> |

- 扩展的地址层次结构

- 灵活的首部格式

- 改进的选项

- 允许协议继续扩充

- 支持即插即用（即自动配置）

- 支持资源的预分配

- IPv6首部改为8字节对齐（即首部长度必须是8字节的整数倍）

### 4.6 其他概念

#### 连接网络的中间设备

从一般的概念来讲，将网络互相连接起来要使用一些中间设备，根据中间设备所在的层次，可以有以下四种不同的**中间设备**。当中间设备是转发器或网桥时，这仅仅是把一个网络扩大了，而从网络层的角度看，这仍然是一个网络，一般并不称之为网络互连。我们讨论**网络互连**时，都是指用**路由器**进行网络互连和路由选择。

1. 物理层使用的中间设备叫**转发器**(repeater)

2. 数据链路层使用的中间设备叫**网桥**或**桥接器**(bridge)

3. 网络层使用的中间设备叫**路由器**(router)

4. 在网络层以上使用的中间设备叫**网关**(gateway)：用网关连接两个不兼容的系统需要在高层进行协议的转换，网关由于比较复杂目前使用得较少。

#### 路由选择协议

**路由选择协议**，就是要讨论路由表中的路由是怎样得出来的。从路由算法能否随网络的通信量或拓扑自适应地进行调整变化来划分，则只有两大类，即**静态路由选择策略**和**动态路由选择策略**。互联网采用的**路由选择协议**主要是**自适应的（即动态的）**、**分布式**路由选择协议。

#### IP多播

在互联网上进行多播就叫做IP多播，IP多播所传送的分组需要使用多播IP地址。

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/48.png" style="zoom:67%;" />

#### 本地地址、专用地址、VPN

假定在一个**机构内部**的计算机通信也是采用TCP/IP协议，那么从原则上讲，对于这些仅在机构内部使用的计算机就可以由本机构自行分配其IP地址，这就是说，让这些计算机使用仅在本机构有效的IP地址（这种地址称为**本地地址**），而不需要向互联网的管理机构申请全球唯一的IP地址（这种地址称为**全球地址**）。这样可以大大节约宝贵的全球IP地址资源。

为避免本地地址有时需要接入互联网而导致和某一全球地址发生冲突，RFC 1918指明了一些**专用地址**(private address)，专用地址只能用做本地地址而不能用作全球地址。在互联网中的所有路由器，对目的地址是专用地址的数据报一律不进行转发。采用专用IP地址的互连网称为**专用互联网**或**本地互联网**，或直接称为**专用网**。显然，全世界可能有很多的专用互连网络具有相同的专用IP地址，但这并不会引起麻烦。专用IP地址也叫做**可重用地址**(reusable address)。

利用公用的互联网作为本机构各专用网之间的通信载体，这样的专用网又称为**虚拟专用网VPN**(Virtual Private Network)。虚拟一词表示VPN只是在效果上和真正的专用网一样，在很多情况下，在VPN中通过互联网传送的数据都必须加密。

#### 127.0.0.1 与 0.0.0.0

> 严格来讲，`0.0.0.0`并不是一个合法的IP地址。

IPv4地址集合里有两个特殊地址：`0.0.0.0`、`127.0.0.1`。命令行中输入`netstat -ano`查看前面几行，如下，它们表示本地系统开放的 tcp4 服务，其中显示本地已开放38127、111、37681等端口，然而这些端口外部都能访问吗？为什么有些端口前面是0.0.0.0，有些却是127.0.0.1呢？

![img](https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/v2-bafd662df654c02d2957b33b04b4fc1a_r.jpg)

- `127.0.0.1`叫 **本地环回地址** ，用于测试协议栈的正确性，它不依赖硬件上是否有接网卡，相当于用一根看不见的网线将网卡的发送和接收端连接起来。
- `0.0.0.0`叫 **任意地址** ，若某个以太网设备存在多块物理网卡，其表示只要本地开放对应的端口服务，无论从哪个网卡发起的连接请求都是允许的。若想限制某服务只允许外部设备从指定网卡入口发起访问，则需要将其配置成具体网卡的IP地址，比如上图中，8081端口只允许从IP地址为192.168.2.3的网卡入口发起。

## 5. 运输层

### 5.1 作用阐释

**运输层**向它上面的应用层提供通信服务，它属于面向通信部分的最高层，同时也是用户功能中的最低层。

运输层还要对收到的报文进行**差错检测**。

IP协议虽然能把分组送到目的主机，但是这个分组还停留在主机的网络层而没有交付主机中的应用进程。从运输层的角度看，**通信的真正端点并不是主机而是主机中的进程**，也就是说，端到端的通信是应用进程之间的通信。

运输层有一个很重要的功能——**复用**(multiplexing)和**分用**(demultiplexing)。

**网络层**为**主机**之间提供逻辑通信，而**运输层**为应用**进程**之间提供端到端的逻辑通信。

### 5.2 运输层协议与协议端口号

运输层根据应用程序的不同需求，需要有两种不同的运输协议，即面向连接的TCP和无连接的UDP：

- 当使用TCP协议时，尽管下面的网络是不可靠的，但这种逻辑通信信道就相当于一条**全双工的可靠信道**；
- 但当使用UDP协议时，这种逻辑通信信道仍然是一条**不可靠信道**。

运输层使用**协议端口号**(protocol port number)，简称**端口**，意味着虽然通信的终点是应用进程，但只要把所传送的报文交到目的主机的某个合适的目的端口，剩下的工作（即最后交付目的进程）就由TCP或UDP来完成。这种端口是**软件端口**，和路由器或交换机上的**硬件端口**是完全不同的概念。由此可见，两个计算机中的进程要互相通信，不仅必须知道对方的IP地址（为了找到对方的计算机），而且要知道对方的端口号（为了找到对方计算机中的应用进程）。

运输层端口号分为两类：

- 服务器端使用的端口号
- 客户端使用的端口号

### 5.3 TCP协议

#### TCP协议的特点

传输控制协议TCP(Transmission Control Protocol)，TCP是TCP/IP体系中非常复杂的一个协议，其最主要的特点是：

- 面向连接：TCP在传送数据前必须先建立连接，数据传送结束后要释放连接，类似打电话
- 每一条TCP连接只能有两个端点，每一条TCP连接只能是点对点的（一对一）
- TCP提供**可靠交付**的服务：TCP下面的网络所提供的是不可靠的传输，因此必须采用适当的措施才能使得两个运输层之间的通信变得可靠，主要有停止等待协议、连续ARQ协议
- TCP提供全双工通信
- 面向字节流

#### 套接字

TCP把连接作为最基本的抽象，TCP连接的端点叫做**套接字**(socket)或**插口**，套接字由端口号拼接到IP地址构成。每一条TCP连接唯一地被通信两端的两个端点（即两个套接字）所确定：
$$
套接字socket=(IP地址: 端口号)
\\
TCP连接::=\{socket_1, socket_2\}=\{(IP_1:port_1),(IP_2:port_2)\}
$$
#### 报文

TCP报文段的**首部格式**如下。其中**确认号**若为$N$，则表明到序号$N-1$为止的所有数据都已正确收到；其中，**窗口字段**明确指出了现在允许对方发送的数据量，窗口值经常在动态变化着。

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/49.png" style="zoom:67%;" />

#### TCP的运输连接

TCP的运输连接有三个阶段，即**连接建立**、**数据传送**、**连接释放**。

##### 三报文握手

TCP建立连接的过程叫做**握手**，是一种采用客户服务器的方式，握手需要在客户和服务器之间交换三个TCP报文段，故称**三报文握手**。

> 三报文握手（three way handshake, RFC 973 最新的文档中有这样的表述：three way (three message) handshake，注意handshake使用的是单数而不是复数，表明只是一次握手）是本教材首次采用的译名，现实中更为流行的是“**三次握手**”的译名，然而在实际上这是在一次握手的过程中交换了三个报文，有点像两个人见面进行一次握手时他们的手上下摇晃了三次，但这并非进行了三次握手，笔者认为三报文握手在意思的表达上更为准确。
>
> |  这些术语   |         这些状态          |
> | :---------: | :-----------------------: |
> |  SYN同步位  |      LISTEN（收听）       |
> | 初始序号seq |  SYN-SENT（同步已发送）   |
> |    ACK位    |   SYN-RCVD（同步收到）    |
> |  确认号ack  | ESTABLISHED（已建立连接） |

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/51.png" style="zoom:67%;" />

上图中B发送给A的报文段也可拆分成两个报文段，可以先发送一个确认报文段（$ACK=1, ack=x+1$），然后再发送一个同步报文段（$SYN=1, seq=y$），这样的过程就变成了**四报文握手**，但效果是一样的。

为什么A最后还要发送一次确认呢？这主要是为了防止已失效的连接请求报文段突然又传送到了B，因而产生错误。

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/52.png" style="zoom:67%;" />

##### 四报文握手

TCP连接释放的过程是**四报文握手**：

> | 这些术语：    | 这些状态                |
> | ------------- | ----------------------- |
> | FIN终止控制位 | FIN-WAIT-1（终止等待1） |
> | 序号seq       | CLOSE-WAIT（关闭等待）  |
> | ACK位         | FIN-WAIT-2（终止等待2） |
> | 确认号ack     | LAST-ACK（最后确认）    |
> |               | TIME-WAIT（时间等待）   |

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/53.png" style="zoom:67%;" />

为什么A在TIME-WAIT状态必须等待2MSL的时间呢？有两个理由：

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/54.png" style="zoom:67%;" />

### 5.4 UDP协议

用户数据报协议UDP(User Datagram Protocol)是**无连接**的，UDP在传送数据之前不需要先建立连接，远地主机的运输层在收到UDP报文后不需要给出任何确认。

### 5.5 流量控制与拥塞控制

流量控制与拥塞控制的关系：

1. **流量控制**(flow control)就是让发送方的发送速率不要太快，要让接收方来得及接收。

2. **网络拥塞**即$\Sigma对资源的需求>可用资源$，网络拥塞是一个非常复杂的问题，不能通过片面地增加资源来解决，这反而可能使网络的性能更坏。所谓**拥塞控制**就是防止过多的数据注入到网络中，使网络中的路由器或链路不致过载。

    <img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/50.png" style="zoom:67%;" />

3. 拥塞控制是一个全局性的过程，而流量控制往往是指点对点通信量的控制，是端到端的问题。

## 6. 应用层

### 6.1 作用阐释

不同的网络应用的应用进程之间，还需要有不同的通信规则，因此在运输层协议之上，还需要有**应用层协议**(application layer protocol)。应用层协议与**网络应用**不是同一个概念，应用层协议只是网络应用的一部分，例如，万维网应用是一种基于客服/服务器体系结构的网络应用。

互联网**公共领域的标准应用的应用层协议**是由RFC文档定义的，大家都可以使用；互联网中还有很多其他应用的应用层协议不是公开的，而是专用的，如很多现有的P2P文件共享系统使用的就是**专用应用层协议**。

### 6.2 DNS

**域名系统DNS(Domain Name System)** 是互联网使用的命名系统，用来把全球人们使用的机器名字转换为IP地址。用户与互联网上某台主机通信时，必须知道对方的IP地址，然而IP地址的形式用户很难记忆，故应用层为了用户记忆各种网络应用，使连接在互联网上的主机拥有了便于记忆的主机名称，DNS的作用即是将主机名字转换为IP地址。

DNS被设计为一个**联机分布式数据库系统**，并采用**客户服务器**方式。DNS使大多数名字都在本地进行解析，仅少量解析需要在互联网上通信，因此DNS系统的效率很高。

任何一个连接在互联网上的主机或路由器，都有一个唯一的层次结构的名字，即**域名**(domain name)。域名只是一个**逻辑概念**，并非计算机所在的物理地址。从语法上讲，每一个域名都由**标号**(label)序列组成，各标号之间用点隔开，如下图。DNS还有这些规定：

![](https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/55.png)

- 域名中的标号都由英文字母和数字组成，每一个标号不超过63个字符（为了方便记忆，最好不超过12个字符），也不区分大小写字母；
- 标号中除连字符(-)外不能使用其他的标点符号；
- 级别最低的域名写在最左边，级别最高的顶级域名写在最右边；
- 由多个标号组成的完整域名总共不超过255个字符。

#### 顶级域名

通常而言，顶级域名TLD(Top Level Domain)共分三大类：

1. 国家顶级域名nTLD，到2012年5月，共有296个

    - cn中国
    - us美国
    - uk英国

2. 通用顶级域名gTLD，到2006年12月，共有20个，其中最先确定的为7个

    | 域名 |        解释        |
    | :--: | :----------------: |
    | com  |      公司企业      |
    | net  |    网络服务机构    |
    | org  |    非营利性组织    |
    | int  |      国际组织      |
    | edu  | 美国专用的教育机构 |
    | gov  |   美国的政府部门   |
    | mil  |   美国的军事部门   |

3. 基础结构域名(infrastructure domain)，只有一个，即arpa，用于反向域名解析，故又称为反向域名。

#### 二级域名

在国家顶级域名下注册的二级域名均由该国家自行确定，我国把二级域名划分为“类别域名”和“行政区域名”两大类：

- 类别域名——共7个

    | 域名 |          解释          |
    | :--: | :--------------------: |
    |  ac  |        科研机构        |
    | com  |   工、商、金融等企业   |
    | edu  |     中国的教育机构     |
    | gov  |     中国的政府机构     |
    | mil  |     中国的国防机构     |
    | net  | 提供互联网络服务的机构 |
    | org  |     非营利性的组织     |

- **行政区域名**——共34个，适用于我国各省、自治区、直辖市，如bj（北京市），js（江苏省）等。

继续划分子域名

一旦某个单位拥有了一个域名，它就可以自已决定是否要进一步划分其下属的子域，不必由其上级机构批准。**域名树的树叶**就是单台计算机的名字，它不能再继续往下划分子域了。

![](https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/56.png)

### 6.3 FTP

文件传送协议FTP(File Transfer Protocol)是互联网上使用得最广泛的文件传送协议，其中基于TCP的为FTP协议，基于UDP的为简单文件传送协议TFTP。在互联网发展的早期，用FTP传送文件约占整个互联网的通信量的三分之一，由电子邮件和域名系统所产生的通信量还小于FTP所产生的通信量；到了1995年，WWW的通信量才首次超过了FTP。

### 6.4 万维网

#### 概念阐释

**万维网WWW**(World Wide Web)并非某种特殊的计算机网络，而是一个大规模的、联机式的信息储藏所，英文简称为**Web**。万维网用链接的方法能非常方便地从互联网上的一个站点访问另一个站点（也就是所谓的“链接到另一个站点”），从而主动地按需获取丰富的信息。

![](https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/57.png)

每一个万维网站点都存放了许多文档，在这些文档中有一些地方的文字是用特殊方式显式的（例如用不同的颜色，或添加了下划线），而当我们将鼠标移动到这些地方时，鼠标的箭头就变成了一只手的形状，这就表明这些地方有一个**链接**(link)，这种链接有时也被称为**超链**(hyperlink)，当我们在这些地方点击鼠标，就可以从这个文档链接到可能相隔很远的另一个文档。

正是由于万维网的出现，使互联网从仅由少数计算机专家使用变为普通百姓也能利用的信息资源。万维网的出现使网站数按指数规律增长，因此，万维网的出现是互联网发展中的一个非常重要的里程碑。

万维网是一个分布式的超媒体(hypermedia)**系统**，它是超文本(hypertext)系统的扩充，所谓超文本是指包含指向其他文档的链接的文本(text)。超文本是万维网的基础。超媒体与超文本的区别是文档内容不同，超文本文档仅包含文本信息，而超媒体文档还包含其他表示方式的信息，如图形、图像、声音、动画、视频图像等。

万维网把大量信息分布在整个互联网上，每台主机上的文档都独立进行管理，对这些文档的增加、修改、删除或重新命名都不需要（实际上也不可能）通知到互联网上成千上万的节点。

万维网以**客户服务器方式**工作。**浏览器**就是在用户主机上的万维网客户程序，万维网文档所驻留的主机则运行服务器程序，因此这台主机也称为**万维网服务器**。在一个客户程序主窗口上显示出的万维网文档称为**页面**(page)。

#### URL

万维网使用统一资源定位符URL(Uniform Resource Locator)来标志万维网上的各种文档，并使每一个文档在整个互联网的范围内具有唯一的标识符URL。

- URL实际上就是在互联网上的资源的地址，相当于一个文件名在网络范围的扩展。
    $$
    <协议>://<主机>:<端口>/<路径>
    $$

    - URL里面的字母不分大小写，但为了全球阅读，有时故意使用一些大写字母
    - 现在最常用的协议就是http（超文本传送协议HTTP），其次是ftp（文件传送协议FTP）
    - 这里的<主机>就是指该主机在互联网上的域名
    - 第三、四部分的<端口>和<路径>有时可省略

- 使用HTTP的URL:

    - HTTP的默认端口号是80，通常可省略

    - 若再省略文件的<路径>项，则URL就指到互联网上的某个**主页**(home page)

    - **主页**是个很重要的概念，它可以是以下几种情况之一：
      - 一个WWW服务器的最高级别页面
      - 某一个组织或部门的一个定制的页面或目录，从这样的页面可链接到互联网上的与本组织或部门有关的其他站点
      - 由某一个人自己设计的描述他本人情况的WWW页面
    

#### HTTP

实现万维网上各种链接的协议为超文本传送协议HTTP(HyperText Transfer Protocol)，HTTP是一个**应用层协议**，它使用TCP连接进行可靠的传送。HTTP协议定义了浏览器怎样向万维网请求万维网文档以及服务器怎样把文档传送给浏览器。

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/58.png" style="zoom:67%;" />

每个万维网网点都有一个服务器进程，它不断地监听TCP的端口80，以便发现是否有浏览器（即万维网客户）向它发出连接建立请求。

HTTP本身是无连接的，但它使用了面向连接的TCP作为运输层协议，保证了数据的可靠传输。

HTTP协议是无状态的。即同一个客户第二次访问同一个服务器上的页面时，服务器的响应与第一次访问时的相同（假定现在服务器没有更新该页面），因为服务器并不记得曾经访问过的这个客户，也不记得为该客户曾经服务过多少次。

用户点击鼠标链接某个万维网文档时，HTTP协议首先要和服务器建立TCP连接，这需要使用三报文握手。当建立TCP连接的三报文握手的前两部分完成后（即经过一个RTT时间后），万维网客户就把HTTP请求报文，作为建立TCP连接的三报文握手中的第三个报文的数据，发送给万维网服务器，服务器收到HTTP请求报文后，就把所请求的文档作为响应报文返回给客户。

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/59.png" style="zoom:67%;" />

HTTP是无状态的，这简化了服务器的设计，但有时我们希望对用户做一些跟踪，这便需要在HTTP中使用**Cookie**。RFC 6265规定万维网站点可以使用Cookie来跟踪用户，Cookie尚无标准译名，其表示在HTTP服务器和客户之间传递的状态信息。但为了让用户有拒绝接受Cookie的自由，在浏览器中用户可自行设置接受Cookie的条件。

| <img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/60.png" style="zoom:67%;" /> | <img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/61.png" style="zoom:67%;" /> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

#### HTML

万维网使用超文本标记语言HTML(HyperText Markup Language)，使得万维网页面的设计者可以很方便地用链接从本页面的某处链接到互联网上的任何一个万维网页面，并且能够在自己的主机屏幕上将这些页面显示出来。

1. HTML并不是应用层的协议，它只是万维网浏览器使用的一种语言
2. 并非所有浏览器都支持所有的HTML标签，若某一个浏览器不支持某一个HTML标签，则浏览器将忽略此标签，但在一对不能识别的标签之间的文本仍然会被显示出来。
3. 链接的终点可以是其他网站上的页面，这种叫做**远程链接**，这时必须在HTML文档中指明链接到的网站的URL；有时链接可以指向本计算机中的某一个文件或本文件中的某处，这叫做**本地链接**，这时必须在HTML文档中指明链接的路径。
4. 实际上，现在这种链接方式已经不局限于在万维网文档中，如在最常用的Word文字处理器的工具栏中，也设有“插入超链接”的按钮。
5. 万维网文档类型：
   - **静态文档**(static document)——在文档创作完毕后就存放在万维网服务器中，在被用户浏览的过程中内容不会改变。
   - **动态文档**(dynamic document)——文档的内容是在浏览器访问万维网服务器时才由应用程序动态创建的，因此用户通过动态文档所看到的内容是不断变化的。如股市行情、天气预报、民航售票等，动态文档的主要优点是具有报告当前最新信息的能力。
   - **活动文档**(active document)——类似于动态文档，但把让屏幕更新的工作都转移给浏览器端，这时活动文档程序可与用户直接交互，并可连续地改变屏幕的显示，由于活动文档技术不需要服务器的连续更新推送，对网络带宽的要求也不会太高。浏览器和服务器都把活动文档看成是静态文档，在服务器上的活动文档的内容是不变的，这点和动态文档不同。

#### 搜索引擎

万维网使用**搜索工具**在万维网上方便地查找所需的信息。

1. 在万维网中用来进行搜索的工具叫做**搜索引擎**(search engine)

2. 搜索引擎可分为两大类：**全文检索搜索引擎**（如谷歌、百度）、**分类目录搜索引擎**（如雅虎、新浪、搜狐、网易）。不过为了便于用户，现在许多网站往往同时具有两种搜索功能。

    ![](https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/62.png)

3. 不管哪种搜索引擎，它们都是告诉你只要链接到什么地方就可以检索到所需的信息，而搜索引擎网站本身并没有直接存储这些信息。

4. 目前出现了**垂直搜索引擎**(Vertical Search Engine)，它是针对某一特定领域、特定人群或某一特定需求提供搜索服务。目前热闹的垂直搜索行业有：购物、旅游、汽车、求职、房产、交友等。

5. 还有一种**元搜索引擎**(Meta Search Engine)，它把用户提交的检索请求发送到多个独立的搜索引擎上去搜索，并把检索结果集中统一处理，以统一的格式提供给用户，因此是搜索引警之上的搜索引擎。

#### 万维网的应用

**建立网站**就是万维网的一种应用。近年来，博客、微博、社交网站等在万维网中广为流行。

1. 博客是万维网日志(weblog)的简称。在博客出现一以前，网民是互联网上内容的消费者，但博客出现后改变了这种善，网民不仅是内容的消费者，也成了互联网上内容的生产者。

2. 博客与个人网站还是有不少区别的，最主要的区别就是建立个人网站成本较高，需要租用个人空间、域名等，建立者还要懂得HTML语言和网页制作等相关技术，而博客则容易得多。

3. 微博即是微型博客(microblog)。

### 6.5 电子邮件

**电子邮析**(e-mail)是互联多使用最多和最受欢迎的一种应用。一个电子邮件系统主要有三个组成构件：**用户代理**、**邮件服务**、**邮件发送协议**和**邮件读取协议**。TCP/IP体系的电子邮件系统规定**电子邮件地址**(e-mail address)的格式为：
$$
用户名@邮件服务器的域名
$$

**用户代理UA(User Agent)** ——即用户与电子邮件系统的接口，在大多数情况下它就是运行有用户电脑中的一个程序，因此又称为电子邮件客户端。

**邮件服务**——互联网上有许多邮件服务器可供用户选用，邮件服务器24小时不间断地工作，并且具有很大容量的邮件信箱，其功能是发送和接收邮件，并向用户报告传送结果。邮件服务器的工作方式是客服服务器方式。

邮件服务器需要使用两种不同的协议：

- 一种用于UA向邮件服务器发送邮件或在邮件服务器之间发送邮件，如简单邮件传送协议**SMTP**(Simple Mail Transfer Protocol)和通用互联网邮件扩充**MIME**(Multipurpose Internet Mail Extensions)；
- 另一种用于UA从邮件服务器读取邮件，如邮局协议的第三个版本**POP3**(Post Office Protocol)和网际报文存取协议**IMAP**(Internet Message Access Protocol)。

<img src="https://chua-n.gitee.io/figure-bed/notebook/杂技/计算机网络/63.png" style="zoom:67%;" />

**基于万维网的电子邮件**——使用万维网电子邮件不需要在计算机中安装用户代理软件，浏览器本身可以向用户提供非常友好的电子邮件界面。

