## 安装WSL

> 参考[如何在 Windows 10 上安装 WSL 2 ](https://zhuanlan.zhihu.com/p/337104547)等。

## WSL与宿主机的网络映射

> 官方文档：[Accessing network applications with WSL | Microsoft Learn](https://learn.microsoft.com/en-us/windows/wsl/networking)。

在结合WSL开发网络应用时，有几点WSL的特殊性需要明确一下：

|    服务端    |    客户端    |                    客户端访问方式                     |
| :----------: | :----------: | :---------------------------------------------------: |
|   本机 WSL   | 本机 Windows |                localhost 即可直接访问                 |
| 本机 Windows |   本机 WSL   |            *必须通过宿主机的IP地址来访问*             |
| 本机 Windows |   其他主机   |               宿主机 IP+PORT，无须多言                |
|   本机 WSL   |   其他主机   | *需要将宿主机相应的端口映射到WSL，然后通过宿主机访问* |

在WSL中获取宿主机IP地址的一个方式为：

- 在WSL中执行`cat /etc/resolv.conf`；

- 命令输出中`nameserver`字段后的内容即为相应IP。

  ![img](../resources/images/notebook/杂技/Linux/wsl2-network-l2w.png)

通过远程主机访问本地主机WSL中的应用程序时，WSL1 和 WSL2 略有区别：

- 在 WSL1 中，可认为 WSL1 和宿主机融为一体，远程主机访问本地 WSL1 中运行的程序与访问本地 Windows 中运行的程序相比并无区别；
- 在 WSL2 中，WSL2 拥有一张虚拟网卡，因此拥有独立的 IP 地址。目前来说，远程主机访问本地 WSL2 中运行的程序时必须像访问本地虚拟机中的程序一样，依照虚拟机的情况进行上述相关设置，而不能认为 WSL2 是一个子系统，微软团队声称他们正在解决这一痛点。

宿主机 Windows 向 WSL 作映射时，通过 powershell 的一个命令即可。如下为一个操作示例：

- WSL 查看 IP 信息：

  ```bash
  chuan@WSL:~$ ifconfig
  eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
          inet 172.17.178.146  netmask 255.255.255.240  broadcast 172.17.178.159
          inet6 fe80::215:5dff:fef8:cd04  prefixlen 64  scopeid 0x20<link>
          ether 00:15:5d:f8:cd:04  txqueuelen 1000  (Ethernet)
          RX packets 14970  bytes 2603065 (2.6 MB)
          RX errors 0  dropped 0  overruns 0  frame 0
          TX packets 1409  bytes 2056139 (2.0 MB)
          TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
  
  lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
          inet 127.0.0.1  netmask 255.0.0.0
          inet6 ::1  prefixlen 128  scopeid 0x10<host>
          loop  txqueuelen 1000  (Local Loopback)
          RX packets 1613  bytes 2099263 (2.0 MB)
          RX errors 0  dropped 0  overruns 0  frame 0
          TX packets 1613  bytes 2099263 (2.0 MB)
          TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
  ```

- Windows 查看 IP 信息：

  ```powershell
  PS C:\Users\chuan> ipconfig
  
  Windows IP 配置
  
  
  以太网适配器 以太网 4:
  
     连接特定的 DNS 后缀 . . . . . . . :
     本地链接 IPv6 地址. . . . . . . . : fe80::90d0:c29a:bcad:ba2d%12
     IPv4 地址 . . . . . . . . . . . . : 10.8.224.5
     子网掩码  . . . . . . . . . . . . : 255.255.254.0
     默认网关. . . . . . . . . . . . . : 10.8.225.254
  
  以太网适配器 以太网 5:
  
     媒体状态  . . . . . . . . . . . . : 媒体已断开连接
     连接特定的 DNS 后缀 . . . . . . . :
  
  以太网适配器 以太网 6:
  
     媒体状态  . . . . . . . . . . . . : 媒体已断开连接
     连接特定的 DNS 后缀 . . . . . . . :
  
  以太网适配器 vEthernet (WSL):
  
     连接特定的 DNS 后缀 . . . . . . . :
     本地链接 IPv6 地址. . . . . . . . : fe80::a5ea:4b35:7ff2:32ba%34
     IPv4 地址 . . . . . . . . . . . . : 172.17.178.145
     子网掩码  . . . . . . . . . . . . : 255.255.255.240
     默认网关. . . . . . . . . . . . . :
  ```

- Windows 的 powershell 执行如下命令：

  ```powershell
  PS C:\Users\chuan> netsh interface portproxy add v4tov4 listenport=7777 listenaddress=0.0.0.0 connectport=7777 connectaddress=172.17.178.146
  ```

  > **TODO**：
  >
  > - `connectaddress` 的值为什么是 `172.17.178.146` 而不是 `172.17.178.145` ？
  >
  > - 内外系统查到的 WSL 的 IP 为什么不同，到底是什么机制导致的？
  >
  > - 同样的问题是，WSL 中通过`cat /etc/resolv.conf`查宿主机的IP，为什么也和Windows下执行`ipconfig`看到的IP不一样？
  >
  >   ```bash
  >   $ cat /etc/resolv.conf
  >   # This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
  >   # [network]
  >   # generateResolvConf = false
  >   nameserver 172.17.178.145
  >   ```

- 可通过如下命令查看 powershell 的端口映射是否设置成功：

  ```powershell
  PS C:\Users\chuan> netsh interface portproxy show all
  
  侦听 ipv4:                 连接到 ipv4:
  
  地址            端口        地址            端口
  --------------- ----------  --------------- ----------
  0.0.0.0         7777        172.17.178.146  7777
  
  ```


## Sysvinit

> `Sysvinit`可参考[技术|浅析 Linux 初始化 init 系统: sysvinit](https://linux.cn/article-4422-1.html)

WSL的Ubuntu，使用`Sysvinit`而不是`Systemd`，因此，当需要使用`Systemd`命令时，需要用`Sysvinit`的相应命令来代替：

|         Systemd command          |        Sysvinit command        |
| :------------------------------: | :----------------------------: |
|  `systemctl start service_name`  |  `service service_name start`  |
|  `systemctl stop service_name`   |  `service service_name stop`   |
| `systemctl restart service_name` | `service service_name restart` |
| `systemctl status service_name`  | `service service_name status`  |
| `systemctl enable service_name`  |  `chkconfig service_name on`   |
| `systemctl disable service_name` |  `chkconfig service_name off`  |

## 其他可配置项目

- [WSL 中的高级设置配置 | Microsoft Learn](https://learn.microsoft.com/zh-cn/windows/wsl/wsl-config#wslconfig)
