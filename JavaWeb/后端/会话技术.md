## 1. 会话技术简介

**会话**的概念（*from清华大学郑莉*）：从一个客户端打开浏览器连接到服务器的某个服务目录，到客户关闭浏览器离开该服务目录称为一个会话，每个会话只对应于一个客户，并且可以跨多个页面。

（*from黑马程序员课程*）浏览器第一次给服务器资源发送请求时，会话建立，直到有一方断开（指客户端浏览器关掉或服务器关掉？）为止。一次会话中包含多次请求和响应。

会话技术的功能：在一次会话的多次请求间，共享数据。

会话技术有两类：Cookie与Session。

|  类型   |                 解释                 |
| :-----: | :----------------------------------: |
| Cookie  |  客户端会话技术：将数据保存到客户端  |
| Session | 服务器端会话技术：将数据保存到服务端 |

## 2. Cookie

### 2.1 Cookie使用步骤

1. 创建Cookie对象，绑定数据：`new Cookie(String name, String value)  `；
2. 发送Cookie对象，即将Cookie对象插入到请求中：`response.addCookie(Cooki cookie)` 
3. 获取Cookie，拿到数据：`Cookie[] request.getCookies()`

### 2.2 Cookie实现原理

> 参见 https://www.bilibili.com/video/BV1uJ411k7wy?p=740 。

Cookie基于响应头set-cookie和请求头cookie实现。

![3](https://chua-n.gitee.io/blog-images/notebooks/JavaWeb/后端/3.png)

### 2.3 Cookie数据保存时长

Cookie数据在浏览器中保存的时间：

1. 默认情况下，当浏览器关闭后，Cookie数据即被销毁，因为数据存储在浏览器内存中。

2. Cookie也可持久化存储：通过Cookie对象的方法`setMaxAge(int seconds)`

    | seconds参数 |                             作用                             |
    | :---------: | :----------------------------------------------------------: |
    |    正数     | 将Cookie数据写到硬盘的文件中，seconds表示这个cookie文件的存话时间 |
    |    负数     |                            默认值                            |
    |     零      |     选择删除Cookie信息，在内存/硬盘中都不再有cookie数据      |

### 2.4 Cookie数据共享

1. 对于同一个tomcat服务器：

    - 默认情况下，如果在一个tomcat服务器中部署了多个web项目，这些web项目中的cookie不能共享；
    - 通过Cookie对象的setPath(String      path)方法，可以设置cookie的获取范围（默认情况下其设置当前的虚拟目录）；
    - 如果要共享，可选择将上述path的范围扩大，如设置为"/"。

2. 对于不同的tomcat服务器：

    - 不同的服务器之间的数据当然不可能直接被共享；

    - 可通过设置Cookie对象的setDomain方法进行共享：

        | 用法                        | 作用                                                   |
        | --------------------------- | ------------------------------------------------------ |
        | `setDomain(String  path)`   | 如果设置一级域名相同，那么多个服务器之间cookie可以共享 |
        | `setDomain(".baidu.com")  ` | 那么tieba.baidu.com和news.baidu.com中的cookie即可共享  |

### 2.5 Cookie的特点

- cookie存储数据在客户端浏览器，可能不太安全；
- 浏览器对单个cookie的大小有限制（一般为4kb），以及对同一个域名下的总cookie数量也有限制（一般为20个）

### 2.6 Cookie的作用

- Cookie一般用于存储少量的不敏感数据；
- 在不登录账户的情况下，完成服务器对客户端的身份识别。

### 2.7 其他注意事项

- 一次可以发送多个cookie，只要创建多个Cookie对象，然后多次使用response调用addCookie方法发送cookie即可（一个cookie相当于一个键值对，多个cookie相当于多个键值对？）。
- 在Tomcat 8之前，cookie不能直接存储中文数据，需要将中文数据转码，一般采用URL编码。
- Cookie案例 https://www.bilibili.com/video/BV1uJ411k7wy?p=746 。

## 3. Session

Session是服务器端会话技术，在一次会话的多次请求间共享数据，将数据保存在服务器端的HttpSession对象中。

和Request、ServletContext对象一样，Session对象也是一个域对象。

Session对象的获取：`HttpSession session = request.getSession();`

在一次会话范围内，多次获取的Session对象始终是同一个对象。

### 3.1 使用HttpSession对象

| 方法                                           | 作用     |
| ---------------------------------------------- | -------- |
| `void setAttribute(String name, Object value)` | 存储数据 |
| `Object getAttribute(String name)`             | 获取数据 |
| `void removeAttribute(String name)`            | 删除数据 |

### 3.2 Session的实现原理

Session的实现是依赖于Cookie的：

![4](https://chua-n.gitee.io/blog-images/notebooks/JavaWeb/后端/4.png)

### 3.3 Session对象的销毁

Session对象的销毁时机：

- 服务器关闭；
- Session对象调用invalidate()方法；
- Session对象的默认失效时间：30分钟。可通过修改配置文件进行更改。

### 3.4 Session的特点

- 用于存储一次会话的多次请求的数据，存储在服务器端；

- 可以存储任意类型、任意大小的数据（Cookie 饼干，Session 主菜）。

### 3.5 其他细节

1. 默认情况下，当客户端关闭后、服务器不关闭，两次获取的Session对象并非同一个。  

    > 如果需要相同，可以创建Cookie，键为JSESSIONID，设置最大存活时间，让cookie持久化保存。
    >
    > ```java
    > Cookie c = new Cookie("JSESSIONID", session.getId());
    > c.setMaxAge(60*60); // 1小时
    > response.addCookie(c);
    > ```

2. 默认情况下，当客户端不关闭、服务器关闭后，两次获取的Session对象不是同一个。 

    > 有时候需要确保这样的Session对象虽然不一样，但是数据不丢失。（IDEA中暂时做不到）。
    >
    > |                   session的钝化                   |                     session的活化                      |
    > | :-----------------------------------------------: | :----------------------------------------------------: |
    > | 在服务器正常关闭之前，将Session对象序列化到硬盘中 | 在服务器启动后，将Session文件转化为内存中的Session对象 |

